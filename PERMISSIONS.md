# æƒé™æ§åˆ¶ç³»ç»Ÿè¯´æ˜

## ğŸ”’ æƒé™æ§åˆ¶æ¦‚è¿°

æœ¬ç³»ç»Ÿå®ç°äº†åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰ï¼Œç¡®ä¿ä¸åŒç”¨æˆ·åªèƒ½è®¿é—®å…¶æƒé™èŒƒå›´å†…çš„åŠŸèƒ½å’Œæ•°æ®ã€‚

## ğŸ‘¥ ç”¨æˆ·è§’è‰²

### 1. è¶…çº§ç®¡ç†å‘˜ (Super Admin)
- **æ ‡è¯†**: `isSuperAdmin: true`
- **æƒé™**: ç³»ç»Ÿæœ€é«˜æƒé™ï¼Œå¯ä»¥æ‰§è¡Œæ‰€æœ‰æ“ä½œ
- **åŠŸèƒ½**: 
  - è®¿é—®ç®¡ç†åå°
  - ç®¡ç†æ‰€æœ‰ç”¨æˆ·
  - ç®¡ç†æ‰€æœ‰é¡¹ç›®
  - æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—
  - ç³»ç»Ÿé…ç½®

### 2. ç®¡ç†å‘˜ (Admin)
- **æ ‡è¯†**: `role: 'admin'`
- **æƒé™**: ç®¡ç†æƒé™ï¼Œå¯ä»¥æ‰§è¡Œå¤§éƒ¨åˆ†ç®¡ç†æ“ä½œ
- **åŠŸèƒ½**:
  - è®¿é—®ç®¡ç†åå°
  - ç®¡ç†ç”¨æˆ·ï¼ˆé™¤è¶…çº§ç®¡ç†å‘˜å¤–ï¼‰
  - ç®¡ç†é¡¹ç›®
  - æŸ¥çœ‹æ—¥å¿—
  - æ•°æ®ç»Ÿè®¡

### 3. æ™®é€šç”¨æˆ· (User)
- **æ ‡è¯†**: `role: 'user'`
- **æƒé™**: åŸºæœ¬ç”¨æˆ·æƒé™
- **åŠŸèƒ½**:
  - è®¿é—®åº”ç”¨é—¨æˆ·
  - æŸ¥çœ‹åˆ†é…çš„é¡¹ç›®
  - æŸ¥çœ‹ä¸ªäººæ—¥å¿—
  - ä¿®æ”¹ä¸ªäººä¿¡æ¯

## ğŸ›¡ï¸ æƒé™æ§åˆ¶å®ç°

### 1. ä¸­é—´ä»¶æ§åˆ¶

#### authMiddleware
- **åŠŸèƒ½**: éªŒè¯ç”¨æˆ·ç™»å½•çŠ¶æ€
- **æ£€æŸ¥**: JWT Token æœ‰æ•ˆæ€§
- **å¤±è´¥å¤„ç†**: è¿”å› 401 æœªæˆæƒ

#### adminMiddleware
- **åŠŸèƒ½**: éªŒè¯ç®¡ç†å‘˜æƒé™
- **æ£€æŸ¥**: ç”¨æˆ·è§’è‰²æ˜¯å¦ä¸º admin æˆ– isSuperAdmin
- **å¤±è´¥å¤„ç†**: 
  - APIè¯·æ±‚: è¿”å› 403 ç¦æ­¢è®¿é—®
  - é¡µé¢è¯·æ±‚: é‡å®šå‘åˆ°ç™»å½•é¡µé¢

### 2. è·¯ç”±æƒé™æ§åˆ¶

#### å…¬å¼€è·¯ç”±
```
GET  /login          - ç™»å½•é¡µé¢
GET  /register       - æ³¨å†Œé¡µé¢
POST /api/auth/login - ç™»å½•æ¥å£
POST /api/auth/register - æ³¨å†Œæ¥å£
```

#### éœ€è¦ç™»å½•çš„è·¯ç”±
```
GET  /portal                    - åº”ç”¨é—¨æˆ·é¡µé¢
GET  /api/portal               - é—¨æˆ·æ•°æ®æ¥å£
GET  /api/users/me             - è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
GET  /api/projects             - è·å–é¡¹ç›®åˆ—è¡¨
GET  /api/users/login-logs     - ä¸ªäººç™»å½•æ—¥å¿—
GET  /api/users/project-access-logs - ä¸ªäººé¡¹ç›®è®¿é—®æ—¥å¿—
POST /api/users/visit-project  - è®°å½•é¡¹ç›®è®¿é—®
POST /api/users/me/change-password - ä¿®æ”¹å¯†ç 
```

#### éœ€è¦ç®¡ç†å‘˜æƒé™çš„è·¯ç”±
```
GET  /admin                           - ç®¡ç†åå°é¡µé¢
GET  /api/users                       - è·å–æ‰€æœ‰ç”¨æˆ·åˆ—è¡¨
GET  /api/users/:id/projects          - è·å–ç”¨æˆ·é¡¹ç›®
PUT  /api/users/:id                   - æ›´æ–°ç”¨æˆ·ä¿¡æ¯
POST /api/users/:id/reset-password    - é‡ç½®ç”¨æˆ·å¯†ç 
PATCH /api/users/:id/activate         - å¯ç”¨ç”¨æˆ·
PATCH /api/users/:id/deactivate       - ç¦ç”¨ç”¨æˆ·
PATCH /api/users/:id/set-admin        - è®¾ä¸ºç®¡ç†å‘˜
PATCH /api/users/:id/unset-admin      - å–æ¶ˆç®¡ç†å‘˜
GET  /api/users/admin-logs            - ç®¡ç†å‘˜æ“ä½œæ—¥å¿—
GET  /api/users/admin/user-login-logs - æ‰€æœ‰ç”¨æˆ·ç™»å½•æ—¥å¿—
GET  /api/users/admin/user-project-access-logs - æ‰€æœ‰ç”¨æˆ·é¡¹ç›®è®¿é—®æ—¥å¿—
GET  /api/users/admin/dashboard-stats - ä»ªè¡¨ç›˜ç»Ÿè®¡
POST /api/projects                    - åˆ›å»ºé¡¹ç›®
PUT  /api/projects/:id                - æ›´æ–°é¡¹ç›®
DELETE /api/projects/:id              - åˆ é™¤é¡¹ç›®
POST /api/projects/assign             - åˆ†é…é¡¹ç›®
POST /api/projects/revoke             - æ’¤é”€é¡¹ç›®
```

## ğŸ¯ å‰ç«¯æƒé™æ§åˆ¶

### 1. é—¨æˆ·é¡µé¢æƒé™æ§åˆ¶

#### ç®¡ç†å‘˜ç”¨æˆ·
- æ˜¾ç¤º"åå°ç®¡ç†ç³»ç»Ÿ"åº”ç”¨å¡ç‰‡
- æ˜¾ç¤º"åº”ç”¨é—¨æˆ·"åº”ç”¨å¡ç‰‡
- æ˜¾ç¤ºåˆ†é…çš„é¡¹ç›®

#### æ™®é€šç”¨æˆ·
- åªæ˜¾ç¤º"åº”ç”¨é—¨æˆ·"åº”ç”¨å¡ç‰‡
- æ˜¾ç¤ºåˆ†é…çš„é¡¹ç›®
- ä¸æ˜¾ç¤ºç®¡ç†åŠŸèƒ½

### 2. ç®¡ç†åå°æƒé™æ§åˆ¶

- åªæœ‰ç®¡ç†å‘˜å¯ä»¥è®¿é—® `/admin` é¡µé¢
- æ™®é€šç”¨æˆ·è®¿é—®ä¼šè¢«é‡å®šå‘åˆ°ç™»å½•é¡µé¢
- æ‰€æœ‰ç®¡ç†åŠŸèƒ½éƒ½éœ€è¦ç®¡ç†å‘˜æƒé™

## ğŸ” æƒé™æµ‹è¯•

### è¿è¡Œæƒé™æµ‹è¯•
```bash
cd /www/wwwroot/usersystem
node scripts/test-permissions.js
```

### æµ‹è¯•å†…å®¹
1. ç®¡ç†å‘˜ç™»å½•æµ‹è¯•
2. æ™®é€šç”¨æˆ·ç™»å½•æµ‹è¯•
3. é—¨æˆ·é¡µé¢æ•°æ®è®¿é—®æµ‹è¯•
4. ç®¡ç†åå°é¡µé¢è®¿é—®æµ‹è¯•
5. ç”¨æˆ·ç®¡ç†APIæµ‹è¯•
6. é¡¹ç›®ç®¡ç†APIæµ‹è¯•
7. ä»ªè¡¨ç›˜APIæµ‹è¯•

### é¢„æœŸç»“æœ
- ç®¡ç†å‘˜: å¯ä»¥è®¿é—®æ‰€æœ‰åŠŸèƒ½
- æ™®é€šç”¨æˆ·: åªèƒ½è®¿é—®åŸºæœ¬åŠŸèƒ½ï¼Œç®¡ç†åŠŸèƒ½è¿”å›403

## ğŸš¨ å®‰å…¨æ³¨æ„äº‹é¡¹

### 1. å‰ç«¯å®‰å…¨
- å‰ç«¯æ˜¾ç¤ºåŸºäºåç«¯è¿”å›çš„æ•°æ®
- é‡è¦æ“ä½œå¿…é¡»é€šè¿‡APIéªŒè¯æƒé™
- ä¸è¦åœ¨å‰ç«¯å­˜å‚¨æ•æ„Ÿæƒé™ä¿¡æ¯

### 2. åç«¯å®‰å…¨
- æ‰€æœ‰æ•æ„Ÿæ“ä½œéƒ½ç»è¿‡ä¸­é—´ä»¶éªŒè¯
- APIæ¥å£ä¸¥æ ¼æ£€æŸ¥ç”¨æˆ·æƒé™
- é¡µé¢è®¿é—®ä¹Ÿéœ€è¦æƒé™éªŒè¯

### 3. æ•°æ®å®‰å…¨
- ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„æ•°æ®
- ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰æ•°æ®
- æ•æ„Ÿæ“ä½œè®°å½•æ—¥å¿—

## ğŸ”§ æƒé™é…ç½®

### ä¿®æ”¹ç”¨æˆ·æƒé™
```javascript
// è®¾ä¸ºç®¡ç†å‘˜
await prisma.user.update({
  where: { id: userId },
  data: { role: 'admin' }
});

// å–æ¶ˆç®¡ç†å‘˜
await prisma.user.update({
  where: { id: userId },
  data: { role: 'user' }
});

// è®¾ä¸ºè¶…çº§ç®¡ç†å‘˜
await prisma.user.update({
  where: { id: userId },
  data: { isSuperAdmin: true }
});
```

### æ·»åŠ æ–°çš„æƒé™æ£€æŸ¥
```javascript
// åœ¨è·¯ç”±ä¸­æ·»åŠ æƒé™ä¸­é—´ä»¶
router.get('/api/sensitive-data', authMiddleware, adminMiddleware, handler);

// åœ¨æ§åˆ¶å™¨ä¸­æ£€æŸ¥æƒé™
if (req.user.role !== 'admin' && !req.user.isSuperAdmin) {
  return res.status(403).json({ message: 'æƒé™ä¸è¶³' });
}
```

## ğŸ“ æ—¥å¿—è®°å½•

### æƒé™ç›¸å…³æ—¥å¿—
- ç”¨æˆ·ç™»å½•/ç™»å‡º
- æƒé™éªŒè¯å¤±è´¥
- æ•æ„Ÿæ“ä½œæ‰§è¡Œ
- ç®¡ç†å‘˜æƒé™å˜æ›´

### æ—¥å¿—æŸ¥çœ‹
```bash
# æŸ¥çœ‹ç®¡ç†å‘˜æ“ä½œæ—¥å¿—
curl -H "Authorization: Bearer <admin_token>" \
  http://localhost:3001/api/users/admin-logs

# æŸ¥çœ‹ç”¨æˆ·ç™»å½•æ—¥å¿—
curl -H "Authorization: Bearer <token>" \
  http://localhost:3001/api/users/login-logs
```

---

é€šè¿‡ä»¥ä¸Šæƒé™æ§åˆ¶æœºåˆ¶ï¼Œç¡®ä¿ç³»ç»Ÿçš„å®‰å…¨æ€§å’Œæ•°æ®çš„å®Œæ•´æ€§ã€‚ 